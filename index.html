<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0" />
    <title>Squancher!</title>
    <link rel="shortcut icon" type="image/png" href="/favicon.ico" />
    <link rel="stylesheet" type="text/css" href="css/materialize.css" media="screen,projection" title="style (screen)" />
    <!-- CSS  -->
    <style>
        /* fallback */

        @font-face {
            font-family: 'Material Icons';
            font-style: normal;
            font-weight: 400;
            src: local('Material Icons'), local('MaterialIcons-Regular'), url(https://fonts.gstatic.com/s/materialicons/v21/2fcrYFNaTjcS6g4U3t-Y5ZjZjT5FdEJ140U2DJYC3mY.woff2) format('woff2');
        }

        .material-icons {
            font-family: 'Material Icons';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-feature-settings: 'liga';
        }

    </style>
    <style>
        /* Custom Stylesheet */
        /**
 * Use this file to override Materialize files so you can update
 * the core Materialize files in the future
 *
 * Made By MaterializeCSS.com
 */

        .icon-block {
            padding: 0 15px;
        }

        .icon-block .material-icons {
            font-size: inherit;
        }

    </style>
</head>

<body>
    <main>
        <div class="section no-pad-bot" id="index-banner">
            <div class="container">
                <h1 class="header center">Squancher</h1>
                <div class="row center">
                    <h5 class="header col s12 light">Search all episodes of Rick and Morty!</h5>
                </div>
                <div class="input-field">
                    <input class="black-text" placeholder="Search by phrase (Wubba lubba dub dubs!)" id="search" type="search" maxlength="48">
                    <label class="label-icon active" for="search"><i class="material-icons">search</i></label>
                </div>
            </div>
        </div>
        <div id="information" class="">
            <div class="container">
                stuff goes here give me credit only 25 schmeckles etc
            </div>
        </div>
        <div id="noResults" class="hide">
            <div class="container valign center">
                no results found :(
                <br>
                <img class="noResult" alt="mmm squishy"/>
            </div>
        </div>
        <div id="subtitles" class="hide">
            <div id="content" class="content">
            </div>
        </div>
    </main>

    <footer class="page-footer">
        <div class="container">
            <div class="row">
                <h5 class="white-text">Wooh im me</h5>
                <p class="grey-text text-lighten-4">Lorum ipsum and stuff yeah!</p>
            </div>
        </div>
        <div class="footer-copyright">
            <div class="container">
                Made by <a class="text-lighten-3" href="http://materializecss.com">Materialize</a>
            </div>
        </div>
    </footer>
    <!--  Scripts-->
    <!--<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="js/materialize.min.js"></script>
-->
    <script>
        var search = document.getElementById("search"),
            information = document.getElementById("information"),
            noResults = document.getElementById("noResults"),
            subtitles = document.getElementById("subtitles"),
            content = document.getElementById("content");
        onload = function() {
            var e = document.getElementById('search');
            e.oninput = searchFunction;
            e.onpropertychange = e.oninput;
            loadFromURL();
        };
        var searchFunction = function(e) {
            var elem = (typeof this.selectedIndex == "undefined" ? window.event.srcElement : this);
            var query = elem.value; //|| elem.options[elem.selectedIndex].value;
            var qlen = query.length;
            if (qlen === 0) {
                information.classList.remove('hide');
                noResults.classList.add('hide');
                subtitles.classList.add('hide');
            } else if (qlen < 3) {
                information.classList.add('hide');
                noResults.classList.remove('hide');
                subtitles.classList.add('hide');
            } else {
                doSearch(query);
                information.classList.add('hide');
                noResults.classList.add('hide');
                subtitles.classList.remove('hide');
            }
        };

        function doSearch(q) {
            AJAX('//wumbo.uk.to/api/search/' + q.toLowerCase(), function(data) {
                if (data.count === 0) {
                    content.innerHTML = "";
                    noResults.classList.remove('hide');
                } else {
                    alarm.setup();
                    var content_fragment = document.createDocumentFragment();
                    noResults.classList.add('hide');
                    for (var i = 0, len = data.subtitles.length; i < len; i++) {
                        var subtitle = document.createElement('div');
                        var subtitle_image = document.createElement('div');
                        var img = document.createElement('img');
                        var subtitle_text = document.createElement('div');
                        subtitle.className += "card";
                        subtitle_image.className += "card-image";
                        subtitle_text.className += "card-content";
                        img.src = "../images/" + data.subtitles[i].Episode + "/" + data.subtitles[i].Episode + "-" + pad(~~(data.subtitles[i].TimeStamp / 1000), 3) + ".jpg";
                        subtitle_text.innerHTML = data.subtitles[i].Text;
                        subtitle_image.appendChild(img);
                        subtitle.appendChild(subtitle_image);
                        subtitle.appendChild(subtitle_text);
                        content_fragment.appendChild(subtitle);
                    }
                    content.innerHTML = "";
                    content.appendChild(content_fragment);
                }
            });
        }

        function AJAX(path, callback) {
            var httpRequest = new XMLHttpRequest();
            httpRequest.onreadystatechange = function() {
                if (httpRequest.readyState === 4) {
                    if (httpRequest.status === 200) {
                        var data = JSON.parse(httpRequest.responseText);
                        if (callback) callback(data);
                    }
                }
            };
            httpRequest.open('GET', path);
            httpRequest.send();
        }
        window.onpopstate = function(event) {
            loadFromURL();
        };
        loadFromURL = function() {
            var q = findGetParameter("q")
            if (q !== null && q.length>3) {
                doSearch(q);
                information.classList.add('hide');
                noResults.classList.add('hide');
                subtitles.classList.remove('hide');
                search.value = q;
            }
        }

        function findGetParameter(parameterName) {
            var result = null,
                tmp = [];
            location.search
                .substr(1)
                .split("&")
                .forEach(function(item) {
                    tmp = item.split("=");
                    if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1]);
                });
            return result;
        }
        // to be removed when I redo the images
        function pad(num, size) {
            var s = num + "";
            while (s.length < size) s = "0" + s;
            return s;
        }

        var alarm = {
            remind: function() {
                history.pushState(null, null, "?q=" + search.value);
                this.timeoutID = undefined;
            },

            setup: function() {
                if (typeof this.timeoutID === 'number') {
                    this.cancel();
                }

                this.timeoutID = window.setTimeout(function(msg) {
                    this.remind(msg);
                }.bind(this), 1500);
            },
            cancel: function() {
                window.clearTimeout(this.timeoutID);
                this.timeoutID = undefined;
            }
        };
        window.onclick = function() {
            alarm.setup();
        };

    </script>
</body>

</html>
